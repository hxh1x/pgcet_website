<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formula Sheet - RVCE Prep</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        .formula-card { 
            background: white; 
            border: 1px solid #e2e8f0; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .formula-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
            border-color: #6366f1; 
        }
        .formula-card.pinned {
            border-color: #f59e0b;
            background-color: #fffbeb;
        }
        .formula-card.pinned::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            border-width: 0 20px 20px 0;
            border-color: transparent #f59e0b transparent transparent; 
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .search-input:focus-within { box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); border-color: #6366f1; }
        
        /* List View Override */
        .view-list .grid-cols-1.lg\:grid-cols-2 { grid-template-columns: 1fr; }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between gap-4">
            <div class="flex items-center gap-4 min-w-fit">
                <a href="index.html" class="group flex items-center justify-center w-10 h-10 rounded-lg bg-slate-50 text-slate-500 hover:bg-indigo-50 hover:text-indigo-600 transition-all">
                    <i data-lucide="arrow-left" size="20" class="group-hover:-translate-x-1 transition-transform"></i>
                </a>
                <div class="hidden sm:block">
                    <h1 class="text-lg font-bold text-slate-900">Formula & Tricks</h1>
                    <p class="text-[10px] font-medium text-slate-400 uppercase tracking-wider">Knowledge Bank</p>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="flex-1 max-w-xl mx-4">
                <div class="relative group search-input border border-slate-200 rounded-lg bg-slate-50 transition-colors">
                    <i data-lucide="search" class="absolute left-3 top-2.5 text-slate-400 group-focus-within:text-indigo-500" size="18"></i>
                    <input type="text" id="search-bar" oninput="handleSearch()" placeholder="Search formulas, tricks, topics..." 
                        class="w-full bg-transparent border-none focus:ring-0 py-2 pl-10 pr-4 text-sm text-slate-700 placeholder-slate-400 outline-none">
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="toggleView()" class="p-2 text-slate-500 hover:bg-slate-100 rounded-lg transition-colors" id="view-toggle-btn" title="Toggle View">
                    <i data-lucide="layout-grid" size="20"></i>
                </button>
                <button onclick="openAddModal()" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors shadow-lg shadow-indigo-200/50">
                    <i data-lucide="plus" size="16"></i> <span class="hidden sm:inline">Add Note</span>
                </button>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden max-w-7xl mx-auto w-full">
        
        <!-- Sidebar Filters -->
        <aside class="w-64 hidden md:flex flex-col border-r border-slate-200 bg-white/50 backdrop-blur p-4 gap-2 overflow-y-auto">
            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 px-2">Filter By Subject</div>
            <button onclick="filterNotes('all')" class="filter-btn active w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors bg-indigo-50 text-indigo-700 flex justify-between group">
                All Topics <span class="bg-indigo-100 text-indigo-600 text-xs px-2 py-0.5 rounded-full" id="count-all">0</span>
            </button>
            <button onclick="filterNotes('Mathematics')" class="filter-btn w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-colors flex justify-between">
                Mathematics <span class="text-xs text-slate-400" id="count-math">0</span>
            </button>
            <button onclick="filterNotes('Reasoning')" class="filter-btn w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-colors flex justify-between">
                Reasoning <span class="text-xs text-slate-400" id="count-reasoning">0</span>
            </button>
            <button onclick="filterNotes('Computer Awareness')" class="filter-btn w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-colors flex justify-between">
                Computer <span class="text-xs text-slate-400" id="count-computer">0</span>
            </button>
            <button onclick="filterNotes('General English')" class="filter-btn w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-colors flex justify-between">
                English <span class="text-xs text-slate-400" id="count-english">0</span>
            </button>
            <button onclick="filterNotes('General Awareness')" class="filter-btn w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-colors flex justify-between">
                GK <span class="text-xs text-slate-400" id="count-gk">0</span>
            </button>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-4 md:p-6 bg-slate-50" id="main-content">
            
            <!-- Quick Stats -->
            <div class="flex gap-4 mb-6 overflow-x-auto pb-2 md:hidden">
                <button onclick="filterNotes('all')" class="whitespace-nowrap px-4 py-1.5 bg-indigo-600 text-white text-xs font-bold rounded-full shadow-sm">All</button>
                <button onclick="filterNotes('Mathematics')" class="whitespace-nowrap px-4 py-1.5 bg-white text-slate-600 border border-slate-200 text-xs font-bold rounded-full shadow-sm">Maths</button>
                <button onclick="filterNotes('Computer Awareness')" class="whitespace-nowrap px-4 py-1.5 bg-white text-slate-600 border border-slate-200 text-xs font-bold rounded-full shadow-sm">Computer</button>
                <!-- Add more as needed for mobile scroll -->
            </div>

            <!-- Custom Formulas Section -->
            <div id="custom-section" class="mb-8">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-sm font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="pen-tool" size="16"></i> My Notes & Formulas
                    </h2>
                    <span class="text-xs text-slate-400" id="custom-total-label">0 items</span>
                </div>
                <div id="custom-container" class="grid grid-cols-1 lg:grid-cols-2 gap-4 transition-all">
                    <!-- Injected via JS -->
                </div>
            </div>

            <!-- Question Insights Section -->
            <div id="insights-section">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-sm font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="book-open" size="16"></i> Learned from Practice
                    </h2>
                    <span class="text-xs text-slate-400" id="insights-total-label">0 items</span>
                </div>
                <div id="insights-container" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- Injected via JS -->
                </div>
            </div>

        </main>
    </div>

    <!-- Add/Edit Note Modal -->
    <div id="add-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl flex flex-col overflow-hidden scale-95 transition-transform duration-200" id="modal-content">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-lg text-slate-800" id="modal-title">Add New Note</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" size="20"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="edit-index" value="-1"> <!-- -1 for new, index for edit -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Subject</label>
                    <select id="new-subject" class="w-full border border-slate-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50">
                        <option value="Mathematics">Mathematics</option>
                        <option value="Reasoning">Reasoning</option>
                        <option value="Computer Awareness">Computer Awareness</option>
                        <option value="General English">General English</option>
                        <option value="General Awareness">General Awareness</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Title</label>
                    <input type="text" id="new-title" class="w-full border border-slate-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none placeholder-slate-400" placeholder="e.g. Matrix Multiplication Shortcut">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Content</label>
                    <textarea id="new-content" class="w-full border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none h-40 resize-none font-mono text-slate-600 placeholder-slate-400" placeholder="Write formula, trick, or concept here..."></textarea>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="new-pinned" class="rounded text-indigo-600 focus:ring-indigo-500 border-gray-300">
                    <label for="new-pinned" class="text-sm text-slate-600 font-medium">Pin to top</label>
                </div>
                <button onclick="saveCustomNote()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition-colors shadow-lg shadow-indigo-200">Save to Sheet</button>
            </div>
        </div>
    </div>

    <script>
        let userData = JSON.parse(localStorage.getItem('rvce_clean_v1') || '{}');
        let customNotes = JSON.parse(localStorage.getItem('rvce_formulas_v1') || '[]');
        let currentFilter = 'all';
        let searchQuery = '';
        let isListView = false;

        // Subject Helper
        function getSubjectColor(subject) {
            if(subject.includes('Math')) return 'bg-blue-100 text-blue-700';
            if(subject.includes('Computer')) return 'bg-purple-100 text-purple-700';
            if(subject.includes('Reasoning')) return 'bg-pink-100 text-pink-700';
            if(subject.includes('English')) return 'bg-orange-100 text-orange-700';
            return 'bg-emerald-100 text-emerald-700'; // Gen Awareness
        }

        function getIcon(subject) {
            if(subject.includes('Math')) return 'sigma';
            if(subject.includes('Computer')) return 'monitor';
            if(subject.includes('Reasoning')) return 'brain-circuit';
            if(subject.includes('English')) return 'languages';
            return 'globe'; 
        }

        function render() {
            const insightsContainer = document.getElementById('insights-container');
            const customContainer = document.getElementById('custom-container');
            insightsContainer.innerHTML = '';
            customContainer.innerHTML = '';

            // Update Counts
            updateCounts();

            // --- 1. Custom Notes ---
            // Filter
            let filteredCustom = customNotes.filter(n => {
                const matchesSubject = currentFilter === 'all' || n.subject === currentFilter;
                const matchesSearch = n.title.toLowerCase().includes(searchQuery) || n.content.toLowerCase().includes(searchQuery);
                return matchesSubject && matchesSearch;
            });

            // Sort: Pinned first
            filteredCustom.sort((a, b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0));

            document.getElementById('custom-total-label').innerText = `${filteredCustom.length} note${filteredCustom.length !== 1 ? 's' : ''}`;

            if (filteredCustom.length === 0) {
                if (customNotes.length === 0) {
                    customContainer.innerHTML = `
                        <div class="col-span-full py-12 flex flex-col items-center justify-center text-center border-2 border-dashed border-slate-200 rounded-xl bg-slate-50/50">
                            <div class="bg-indigo-50 p-3 rounded-full mb-3 text-indigo-400"><i data-lucide="file-plus" size="24"></i></div>
                            <h3 class="text-slate-900 font-bold mb-1">Your Knowledge Bank is Empty</h3>
                            <p class="text-slate-500 text-sm mb-4">Start collecting important formulas and tricks.</p>
                            <button onclick="openAddModal()" class="text-indigo-600 font-bold text-sm hover:underline">Add First Note</button>
                        </div>`;
                } else {
                    customContainer.innerHTML = `<div class="col-span-full text-center py-8 text-slate-400 text-sm italic">No notes found matching your filters.</div>`;
                }
            } else {
                filteredCustom.forEach((note, idx) => {
                    // Find actual index in main array for edit/delete
                    const realIdx = customNotes.indexOf(note); 
                    const pinClass = note.pinned ? 'pinned ring-1 ring-amber-400' : '';
                    const pinIconClass = note.pinned ? 'text-amber-500 fill-amber-500' : 'text-slate-300 hover:text-amber-500';

                    const html = `
                        <div class="formula-card rounded-xl p-5 flex flex-col gap-3 group ${pinClass}">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-2">
                                    <span class="${getSubjectColor(note.subject)} text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wide flex items-center gap-1">
                                        <i data-lucide="${getIcon(note.subject)}" size="10"></i> ${note.subject}
                                    </span>
                                </div>
                                <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="copyToClipboard('${note.content.replace(/'/g, "\\'")}')" class="text-slate-300 hover:text-blue-500 p-1 rounded" title="Copy">
                                        <i data-lucide="copy" size="14"></i>
                                    </button>
                                    <button onclick="openEditModal(${realIdx})" class="text-slate-300 hover:text-indigo-500 p-1 rounded" title="Edit">
                                        <i data-lucide="edit-3" size="14"></i>
                                    </button>
                                    <button onclick="togglePin(${realIdx})" class="${pinIconClass} p-1 rounded transition-colors" title="Pin">
                                        <i data-lucide="pin" size="14"></i>
                                    </button>
                                    <button onclick="deleteCustom(${realIdx})" class="text-slate-300 hover:text-red-500 p-1 rounded" title="Delete">
                                        <i data-lucide="trash-2" size="14"></i>
                                    </button>
                                </div>
                            </div>
                            <h3 class="font-bold text-slate-900 text-base">${note.title}</h3>
                            <div class="relative">
                                <p class="text-slate-600 text-sm leading-relaxed whitespace-pre-wrap font-mono bg-slate-50 p-3 rounded-lg border border-slate-100 overflow-x-auto">${note.content}</p>
                            </div>
                        </div>
                    `;
                    customContainer.innerHTML += html;
                });
            }

            // --- 2. Question Insights (Auto-imported) ---
            const keys = Object.keys(userData).filter(k => userData[k].takeaways && userData[k].takeaways.trim() !== "");
            
            // Map keys to objects for filtering
            let insightItems = keys.map(k => {
                const [year, qId] = k.split('-');
                return { key: k, year, qId, note: userData[k].takeaways };
            });

            // Filter Insights
            insightItems = insightItems.filter(item => {
                const contentMatch = item.note.toLowerCase().includes(searchQuery);
                // Simple Subject Inference for filtering (if strict filtering needed, we'd need the subject map)
                // For now, in "all" view we show all. In specific views, we try to match if possible, or hide if no mapping available.
                // Assuming Main DB isn't loaded here, we skip subject filtering for Insights unless we store subject in userData.
                // For this demo: Insights show in "All" or match search text.
                return contentMatch && (currentFilter === 'all' || getSubjectFromID(item.qId) === currentFilter); // Approximation
            });

            document.getElementById('insights-total-label').innerText = `${insightItems.length} item${insightItems.length !== 1 ? 's' : ''}`;

            if (insightItems.length === 0) {
                if (keys.length === 0) {
                    insightsContainer.innerHTML = `<div class="col-span-full py-8 text-center text-slate-400 text-sm border-2 border-dashed border-slate-200 rounded-xl">Solve questions and use the "What To Remember" box to populate this section automatically.</div>`;
                } else {
                    insightsContainer.innerHTML = `<div class="col-span-full text-center py-8 text-slate-400 text-sm italic">No insights match your search.</div>`;
                }
            } else {
                insightItems.forEach(item => {
                    const html = `
                        <div class="formula-card rounded-xl p-5 flex flex-col gap-3 group hover:border-blue-400">
                            <div class="flex justify-between items-start">
                                <span class="bg-slate-100 text-slate-600 text-[10px] font-bold px-2 py-1 rounded border border-slate-200 uppercase tracking-wide">
                                    ${item.year} â€¢ ${item.qId}
                                </span>
                                <a href="${item.year}.html" class="text-slate-300 hover:text-blue-600 transition-colors flex items-center gap-1 text-xs font-bold">
                                    View Q <i data-lucide="external-link" size="12"></i>
                                </a>
                            </div>
                            <p class="text-slate-700 text-sm font-medium leading-relaxed whitespace-pre-wrap">${item.note}</p>
                        </div>
                    `;
                    insightsContainer.innerHTML += html;
                });
            }

            lucide.createIcons();
        }

        // --- Helpers ---
        function updateCounts() {
            // Calculate counts for sidebar badges
            const subjects = ['Mathematics', 'Reasoning', 'Computer Awareness', 'General English', 'General Awareness'];
            
            // Count Custom Notes
            const total = customNotes.length;
            document.getElementById('count-all').innerText = total;

            subjects.forEach(sub => {
                const count = customNotes.filter(n => n.subject === sub).length;
                const idMap = {'Mathematics': 'math', 'Reasoning': 'reasoning', 'Computer Awareness': 'computer', 'General English': 'english', 'General Awareness': 'gk'};
                if(document.getElementById(`count-${idMap[sub]}`))
                    document.getElementById(`count-${idMap[sub]}`).innerText = count;
            });
        }

        // Simple heuristic for insight filtering (Optional improvement)
        function getSubjectFromID(id) {
            // Can be expanded if we pass subject data
            return 'General'; 
        }

        function filterNotes(subject) {
            currentFilter = subject;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-50', 'text-indigo-700');
                btn.classList.add('text-slate-600', 'hover:bg-slate-50');
            });
            event.currentTarget.classList.add('bg-indigo-50', 'text-indigo-700');
            event.currentTarget.classList.remove('text-slate-600', 'hover:bg-slate-50');
            render();
        }

        function handleSearch() {
            searchQuery = document.getElementById('search-bar').value.toLowerCase();
            render();
        }

        function toggleView() {
            isListView = !isListView;
            const main = document.getElementById('main-content');
            const btn = document.getElementById('view-toggle-btn');
            
            if (isListView) {
                main.classList.add('view-list');
                btn.innerHTML = '<i data-lucide="rows" size="20"></i>';
            } else {
                main.classList.remove('view-list');
                btn.innerHTML = '<i data-lucide="layout-grid" size="20"></i>';
            }
            lucide.createIcons();
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                alert("Copied to clipboard!");
            } catch (err) {
                console.error('Failed to copy: ', err);
            }
        }

        // --- Modal Logic ---
        function openAddModal() {
            document.getElementById('modal-title').innerText = "Add New Note";
            document.getElementById('edit-index').value = "-1";
            document.getElementById('new-title').value = "";
            document.getElementById('new-content').value = "";
            document.getElementById('new-subject').value = "Mathematics";
            document.getElementById('new-pinned').checked = false;
            
            document.getElementById('add-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-content').classList.remove('scale-95'), 10);
        }

        function openEditModal(idx) {
            const note = customNotes[idx];
            document.getElementById('modal-title').innerText = "Edit Note";
            document.getElementById('edit-index').value = idx;
            document.getElementById('new-subject').value = note.subject;
            document.getElementById('new-title').value = note.title;
            document.getElementById('new-content').value = note.content;
            document.getElementById('new-pinned').checked = note.pinned || false;

            document.getElementById('add-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-content').classList.remove('scale-95'), 10);
        }

        function closeModal() {
            document.getElementById('modal-content').classList.add('scale-95');
            setTimeout(() => document.getElementById('add-modal').classList.add('hidden'), 150);
        }

        function saveCustomNote() {
            const subject = document.getElementById('new-subject').value;
            const title = document.getElementById('new-title').value;
            const content = document.getElementById('new-content').value;
            const pinned = document.getElementById('new-pinned').checked;
            const idx = parseInt(document.getElementById('edit-index').value);

            if(!title || !content) {
                alert("Please fill in title and content.");
                return;
            }

            const noteData = { subject, title, content, pinned, date: new Date().toISOString() };

            if (idx === -1) {
                // Add New
                customNotes.unshift(noteData);
            } else {
                // Update Existing
                customNotes[idx] = noteData;
            }

            localStorage.setItem('rvce_formulas_v1', JSON.stringify(customNotes));
            closeModal();
            render();
        }

        function togglePin(idx) {
            customNotes[idx].pinned = !customNotes[idx].pinned;
            localStorage.setItem('rvce_formulas_v1', JSON.stringify(customNotes));
            render();
        }

        function deleteCustom(idx) {
            if(confirm("Delete this note permanently?")) {
                customNotes.splice(idx, 1);
                localStorage.setItem('rvce_formulas_v1', JSON.stringify(customNotes));
                render();
            }
        }

        window.onload = () => {
            render();
            lucide.createIcons();
        }
    </script>
</body>
</html>
